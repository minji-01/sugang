import streamlit as st
import pandas as pd

# ------------------------------
# 1. ê³¼ëª© ë°ì´í„° ì •ì˜
# ------------------------------
subjects = [
    # 2í•™ë…„ 2í•™ê¸° ì„ íƒ ê³¼ëª©
    {"í•™ë…„":2,"ê³¼ëª©ëª…":"ê³ ê¸‰ ëŒ€ìˆ˜","í•™ì ":4,"ë¶„ë¥˜":"ìˆ˜í•™","ì „ê³µ":True},
    {"í•™ë…„":2,"ê³¼ëª©ëª…":"ê³ ê¸‰ ë¯¸ì ë¶„","í•™ì ":4,"ë¶„ë¥˜":"ìˆ˜í•™","ì „ê³µ":True},
    {"í•™ë…„":2,"ê³¼ëª©ëª…":"ë¬¼ë¦¬í•™ ì‹¤í—˜","í•™ì ":3,"ë¶„ë¥˜":"ê³¼í•™","ì „ê³µ":True},
    {"í•™ë…„":2,"ê³¼ëª©ëª…":"í™”í•™ ì‹¤í—˜","í•™ì ":3,"ë¶„ë¥˜":"ê³¼í•™","ì „ê³µ":True},
    {"í•™ë…„":2,"ê³¼ëª©ëª…":"ìƒëª…ê³¼í•™ ì‹¤í—˜","í•™ì ":3,"ë¶„ë¥˜":"ê³¼í•™","ì „ê³µ":True},
    {"í•™ë…„":2,"ê³¼ëª©ëª…":"ì§€êµ¬ê³¼í•™ ì‹¤í—˜","í•™ì ":3,"ë¶„ë¥˜":"ê³¼í•™","ì „ê³µ":True},
    {"í•™ë…„":2,"ê³¼ëª©ëª…":"ì¸ê³µì§€ëŠ¥ ì¼ë°˜","í•™ì ":3,"ë¶„ë¥˜":"ì •ë³´","ì „ê³µ":True},

    # 3í•™ë…„ ì„ íƒ ê³¼ëª©
    {"í•™ë…„":3,"ê³¼ëª©ëª…":"ì‚¬íšŒë¬¸ì œ íƒêµ¬","í•™ì ":2,"ë¶„ë¥˜":"ì‚¬íšŒ","ì „ê³µ":False},
    {"í•™ë…„":3,"ê³¼ëª©ëª…":"ê¸°í›„ë³€í™”ì™€ ì§€ì†ê°€ëŠ¥í•œ ì„¸ê³„","í•™ì ":2,"ë¶„ë¥˜":"ì‚¬íšŒ","ì „ê³µ":False},
    {"í•™ë…„":3,"ê³¼ëª©ëª…":"APë¯¸ì ë¶„í•™â… ","í•™ì ":5,"ë¶„ë¥˜":"ìˆ˜í•™","ì „ê³µ":True},
    {"í•™ë…„":3,"ê³¼ëª©ëª…":"APì¼ë°˜ë¬¼ë¦¬â… ","í•™ì ":5,"ë¶„ë¥˜":"ê³¼í•™","ì „ê³µ":True},
    {"í•™ë…„":3,"ê³¼ëª©ëª…":"APì¼ë°˜í™”í•™â… ","í•™ì ":5,"ë¶„ë¥˜":"ê³¼í•™","ì „ê³µ":True},
    {"í•™ë…„":3,"ê³¼ëª©ëª…":"APì¼ë°˜ìƒë¬¼í•™â… ","í•™ì ":5,"ë¶„ë¥˜":"ê³¼í•™","ì „ê³µ":True},
    {"í•™ë…„":3,"ê³¼ëª©ëª…":"ì²œë¬¸í•™ ì„¸ë¯¸ë‚˜","í•™ì ":3,"ë¶„ë¥˜":"ê³¼í•™","ì „ê³µ":True},
    {"í•™ë…„":3,"ê³¼ëª©ëª…":"ì •ë³´ ê³¼ì œ ì—°êµ¬","í•™ì ":3,"ë¶„ë¥˜":"ì •ë³´","ì „ê³µ":True},
    {"í•™ë…„":3,"ê³¼ëª©ëª…":"ì´ì‚° ìˆ˜í•™","í•™ì ":3,"ë¶„ë¥˜":"ìˆ˜í•™","ì „ê³µ":True},
    {"í•™ë…„":3,"ê³¼ëª©ëª…":"APì¼ë°˜ë¬¼ë¦¬â…¡","í•™ì ":5,"ë¶„ë¥˜":"ê³¼í•™","ì „ê³µ":True},
    {"í•™ë…„":3,"ê³¼ëª©ëª…":"APì¼ë°˜í™”í•™â…¡","í•™ì ":5,"ë¶„ë¥˜":"ê³¼í•™","ì „ê³µ":True},
    {"í•™ë…„":3,"ê³¼ëª©ëª…":"ì¸ê°„ìƒí™œê³¼ ìƒëª…ê³¼í•™","í•™ì ":3,"ë¶„ë¥˜":"ê³¼í•™","ì „ê³µ":True},
    {"í•™ë…„":3,"ê³¼ëª©ëª…":"ì§€êµ¬ê³¼í•™ê°œë¡ ","í•™ì ":3,"ë¶„ë¥˜":"ê³¼í•™","ì „ê³µ":True},
]

df_subjects = pd.DataFrame(subjects)
df_subjects["ì „ê³µê³¼ëª©"] = df_subjects["ì „ê³µ"].apply(lambda x: "â­•ï¸" if x else "")

# ------------------------------
# 2. ê°€ìƒ DB (í•™ìƒë³„ ìˆ˜ê°• ì‹ ì²­ ë‚´ì—­ ì €ì¥)
# ------------------------------
if "students" not in st.session_state:
    st.session_state["students"] = {}  # {í•™ë²ˆ: {"ì´ë¦„": str, "ì„ íƒê³¼ëª©": [list]}}

# ------------------------------
# 3. ë¡œê·¸ì¸/ê´€ë¦¬ì ëª¨ë“œ
# ------------------------------
st.sidebar.title("ë¡œê·¸ì¸")
user_type = st.sidebar.radio("ëª¨ë“œ ì„ íƒ", ["í•™ìƒ","ê´€ë¦¬ì"])

# ------------------------------
# 4. í•™ìƒ ëª¨ë“œ
# ------------------------------
if user_type == "í•™ìƒ":
    st.title("ğŸ“š ìˆ˜ê°• ì‹ ì²­ ì‹œìŠ¤í…œ")
    student_id = st.text_input("í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”")
    student_name = st.text_input("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”")

    if student_id and student_name:
        st.write("### ì„ íƒ ê°€ëŠ¥í•œ ê³¼ëª© ëª©ë¡")
        st.dataframe(df_subjects[["í•™ë…„","ê³¼ëª©ëª…","í•™ì ","ë¶„ë¥˜","ì „ê³µê³¼ëª©"]], use_container_width=True)

        selected = st.multiselect("ìˆ˜ê°•í•  ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”", df_subjects["ê³¼ëª©ëª…"].tolist())

        if st.button("ì‹ ì²­ ì™„ë£Œ"):
            st.session_state["students"][student_id] = {
                "ì´ë¦„": student_name,
                "ì„ íƒê³¼ëª©": selected
            }
            st.success(f"{student_name} í•™ìƒì˜ ìˆ˜ê°• ì‹ ì²­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

        # ë³¸ì¸ ì‹ ì²­ ë‚´ì—­ í™•ì¸
        if student_id in st.session_state["students"]:
            my_data = st.session_state["students"][student_id]
            st.subheader("ğŸ“Œ ë‚´ ìˆ˜ê°• ì‹ ì²­ ë‚´ì—­")
            st.write(pd.DataFrame(df_subjects[df_subjects["ê³¼ëª©ëª…"].isin(my_data["ì„ íƒê³¼ëª©"])]))

# ------------------------------
# 5. ê´€ë¦¬ì ëª¨ë“œ
# ------------------------------
if user_type == "ê´€ë¦¬ì":
    st.title("ğŸ›  ê´€ë¦¬ì ëª¨ë“œ: í•™ìƒ ìˆ˜ê°• ì‹ ì²­ ê´€ë¦¬")

    if not st.session_state["students"]:
        st.info("ì•„ì§ ìˆ˜ê°• ì‹ ì²­í•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.")
    else:
        for sid, data in st.session_state["students"].items():
            st.write(f"### {data['ì´ë¦„']} ({sid})")

            # ê¸°ì¡´ ì„ íƒ í‘œì‹œ
            current_selection = data["ì„ íƒê³¼ëª©"]

            new_selection = st.multiselect(
                f"{data['ì´ë¦„']} í•™ìƒ ìˆ˜ê°• ê³¼ëª© ìˆ˜ì •",
                df_subjects["ê³¼ëª©ëª…"].tolist(),
                default=current_selection,
                key=sid
            )

            if st.button(f"ì €ì¥ ({data['ì´ë¦„']})", key=f"save_{sid}"):
                st.session_state["students"][sid]["ì„ íƒê³¼ëª©"] = new_selection
                st.success(f"{data['ì´ë¦„']} í•™ìƒì˜ ìˆ˜ê°• ì‹ ì²­ ë‚´ì—­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")

    # ì „ì²´ í•™ìƒ ìˆ˜ê°• í˜„í™© ì¶œë ¥
    st.subheader("ğŸ“Š ì „ì²´ í•™ìƒ ìˆ˜ê°• ì‹ ì²­ í˜„í™©")
    all_data = []
    for sid, data in st.session_state["students"].items():
        for subj in data["ì„ íƒê³¼ëª©"]:
            all_data.append({"í•™ë²ˆ": sid, "ì´ë¦„": data["ì´ë¦„"], "ê³¼ëª©ëª…": subj})
    if all_data:
        st.dataframe(pd.DataFrame(all_data))
